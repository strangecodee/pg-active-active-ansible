- name: Add PostgreSQL GPG key
  apt_key:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    state: present

- name: Add PGDG repository
  apt_repository:
    repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
    state: present
    filename: pgdg

- name: Install PostgreSQL 16 and pglogical
  apt:
    name:
      - postgresql-16
      - postgresql-client-16
      - postgresql-contrib-16
      - postgresql-16-pglogical
      - postgresql-common
    state: present
    update_cache: yes

- name: Check if PostgreSQL cluster exists
  shell: pg_lsclusters | awk '{print $1,$2}' | grep -q "^16 main$"
  register: cluster_check
  failed_when: false
  changed_when: false

- name: Create PostgreSQL cluster if missing
  command: pg_createcluster 16 main
  when: cluster_check.rc != 0

- name: Ensure WAL directory exists
  file:
    path: "{{ pg_wal }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'

# ---- PostgreSQL Core + pglogical Settings (Safe Override) ----
- name: Apply HA and Logical Replication settings
  lineinfile:
    path: /etc/postgresql/16/main/postgresql.conf
    regexp: "^{{ item.param }}\\s*="
    line: "{{ item.param }} = {{ item.value }}"
  loop:
    - { param: "wal_level", value: "logical" }
    - { param: "max_replication_slots", value: "10" }
    - { param: "max_wal_senders", value: "10" }
    - { param: "max_logical_replication_workers", value: "8" }
    - { param: "shared_preload_libraries", value: "'pglogical'" }
    - { param: "synchronous_commit", value: "off" }
    - { param: "wal_compression", value: "on" }
    - { param: "checkpoint_timeout", value: "15min" }
    - { param: "checkpoint_completion_target", value: "0.9" }
    - { param: "listen_addresses", value: "'*'" }
    - { param: "tcp_keepalives_idle", value: "30" }
    - { param: "tcp_keepalives_interval", value: "10" }
    - { param: "tcp_keepalives_count", value: "5" }
  notify: restart postgres

# ---- Deterministic Node Identity ----
- name: Set node role
  lineinfile:
    path: /etc/postgresql/16/main/postgresql.conf
    regexp: "^app.node_role"
    line: "app.node_role = '{{ node_role }}'"
  notify: restart postgres

# ---- pg_hba.conf Safe HA Rules ----
- name: Add HA rules to pg_hba.conf
  blockinfile:
    path: /etc/postgresql/16/main/pg_hba.conf
    marker: "# {mark} ANSIBLE ACTIVE-ACTIVE"
    block: |
      # Application via DNS
      host    all             all                    {{ db_dns_name }}/32       md5

      # Application via IP
      # host    all             all                    {{ vip_ip }}/32            md5

      # Replication user
      host    replication     {{ repl_user }}        10.0.0.0/24                md5

      # FDW / internal traffic
      host    all             {{ repl_user }}        10.0.0.0/24                md5
  notify: reload postgres

- name: Start PostgreSQL 16 cluster
  systemd:
    name: postgresql@16-main
    state: started
    enabled: yes
